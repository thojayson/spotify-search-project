<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Search & Play</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            margin: 0;
            padding: 0;
        }

        nav {
            background: #1db954;
            color: white;
            padding: 1rem;
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        nav .logo h1 {
            margin: 0;
        }

        nav .search-container {
            display: flex;
        }

        nav input {
            padding: 0.5rem;
            border: none;
            border-radius: 4px;
            margin-right: 10px;
        }

        nav button {
            padding: 0.5rem 1rem;
            background-color: #1db954;
            border: none;
            color: white;
            border-radius: 4px;
            cursor: pointer;
        }

        #results {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .result-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .result-item img {
            width: 50px;
            height: 50px;
            margin-right: 15px;
        }

        #spotify-player {
            display: none;
            padding: 20px;
            background: #000;
            color: white;
            position: fixed;
            bottom: 0;
            width: 100%;
            left: 0;
        }

        .sidebar {
            width: 250px;
            background: #121212;
            color: white;
            padding: 20px;
            display: flex;
            flex-direction: column;
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            overflow-y: auto;
        }

        .sidebar h2 {
            margin-top: 0;
        }

        .playlist-item {
            margin-bottom: 10px;
            cursor: pointer;
        }

        .playlist-item:hover {
            color: #1db954;
        }

        .search-results {
            flex: 1;
            margin-left: 270px;
        }
    </style>
</head>
<body>
    <nav>
        <div class="logo">
            <h1>Spotify Search & Play</h1>
        </div>
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="Search for songs, artists, or genres" />
            <button id="searchBtn">Search</button>
        </div>
        <!-- Login Button -->
        <button id="loginBtn">Login with Spotify</button>
    </nav>

    <!-- Sidebar for Playlists -->
    <div class="sidebar" id="playlistSidebar">
        <h2>Your Playlists</h2>
        <div id="playlists"></div>
    </div>

    <!-- Main Content Area for Search Results -->
    <div id="results" class="search-results"></div>

    <!-- Spotify Web Playback Player -->
    <div id="spotify-player">
        <div id="player"></div>
        <button id="playBtn">Play</button>
        <button id="pauseBtn">Pause</button>
        <button id="nextBtn">Next</button>
        <button id="prevBtn">Prev</button>
    </div>

    <script>
        const searchBtn = document.getElementById("searchBtn");
        const searchInput = document.getElementById("searchInput");
        const resultsDiv = document.getElementById("results");
        const loginBtn = document.getElementById("loginBtn");
        const playBtn = document.getElementById("playBtn");
        const pauseBtn = document.getElementById("pauseBtn");
        const nextBtn = document.getElementById("nextBtn");
        const prevBtn = document.getElementById("prevBtn");
        const spotifyPlayerDiv = document.getElementById("spotify-player");
        const playlistSidebar = document.getElementById("playlistSidebar");
        const playlistsDiv = document.getElementById("playlists");

        const clientID = "91786cabf39742208a39728600d93595";
        const clientSecret = "ba8b994793d54ebd9a02e8fe2271accb";
        const redirectUri = "https://thojayson.github.io/spotify-search-project/";
        let accessToken = null;
        let player = null;
        let currentTrackUri = null;

        // Check if the user is logged in
        function checkLoginStatus() {
            const token = localStorage.getItem("access_token");
            if (token) {
                accessToken = token;
                loginBtn.textContent = "Logged In";
                loginBtn.disabled = true;
                initializeSpotifyPlayer();  // Initialize the player when logged in
                loadPlaylists(); // Load playlists once logged in
            }
        }

        // Redirect to Spotify login
        function loginSpotify() {
            const authUrl = `https://accounts.spotify.com/authorize?client_id=${clientID}&response_type=code&redirect_uri=${encodeURIComponent(redirectUri)}&scope=user-library-read playlist-read-private playlist-read-collaborative streaming`;
            window.location.href = authUrl;
        }

        // Get access token from authorization code
        async function getAccessTokenFromCode(code) {
            const response = await fetch("https://accounts.spotify.com/api/token", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    "Authorization": "Basic " + btoa(clientID + ":" + clientSecret)
                },
                body: new URLSearchParams({
                    grant_type: "authorization_code",
                    code: code,
                    redirect_uri: redirectUri
                })
            });

            const data = await response.json();
            if (data.access_token) {
                accessToken = data.access_token;
                localStorage.setItem("access_token", accessToken); // Store token
                window.location.href = "/"; // Redirect back to homepage
            }
        }

        // Load user's playlists
        async function loadPlaylists() {
            const response = await fetch("https://api.spotify.com/v1/me/playlists", {
                method: "GET",
                headers: {
                    "Authorization": "Bearer " + accessToken
                }
            });

            const data = await response.json();
            playlistsDiv.innerHTML = "";
            if (data && data.items) {
                data.items.forEach(playlist => {
                    const playlistDiv = document.createElement("div");
                    playlistDiv.classList.add("playlist-item");
                    playlistDiv.textContent = playlist.name;
                    playlistDiv.addEventListener("click", () => loadPlaylistTracks(playlist.id));
                    playlistsDiv.appendChild(playlistDiv);
                });
            }
        }

        // Load tracks from a specific playlist
        async function loadPlaylistTracks(playlistId) {
            const response = await fetch(`https://api.spotify.com/v1/playlists/${playlistId}/tracks`, {
                method: "GET",
                headers: {
                    "Authorization": "Bearer " + accessToken
                }
            });

            const data = await response.json();
            displayResults(data);
        }

        // Search Spotify API for tracks
        async function searchSpotify(query) {
            const response = await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track,artist,album&limit=10`, {
                method: "GET",
                headers: {
                    "Authorization": "Bearer " + accessToken
                }
            });

            const data = await response.json();
            return data;
        }

        // Display search results
        function displayResults(data) {
            resultsDiv.innerHTML = "";
            if (data && data.tracks && data.tracks.items.length > 0) {
                data.tracks.items.forEach(track => {
                    const trackDiv = document.createElement("div");
                    trackDiv.classList.add("result-item");

                    const trackImage = track.album.images[2]?.url || "https://via.placeholder.com/50";
                    const trackLink = track.external_urls.spotify;
                    trackDiv.innerHTML = `
                        <img src="${trackImage}" alt="${track.name}" />
                        <a href="javascript:void(0)" onclick="playSong('${track.uri}')">${track.name} - ${track.artists[0].name}</a>
                    `;
                    resultsDiv.appendChild(trackDiv);
                });
            } else {
                resultsDiv.innerHTML = "No results found.";
            }
        }

        // Play selected song
        function playSong(uri) {
            if (player) {
                currentTrackUri = uri;  // Store the current song's URI
                player.play({ uris: [uri] }).catch(e => console.log(e));
            }
        }

        // Initialize Spotify Player
        function initializeSpotifyPlayer() {
            const script = document.createElement("script");
            script.src = "https://sdk.scdn.co/spotify-player.js";
            document.body.appendChild(script);

            script.onload = () => {
                window.onSpotifyWebPlaybackSDKReady = () => {
                    player = new Spotify.Player({
                        name: "Web Playback SDK",
                        getOAuthToken: (cb) => { cb(accessToken); },
                        volume: 0.5
                    });

                    // Error handling
                    player.addListener("initialization_error", ({ message }) => { console.error(message); });
                    player.addListener("authentication_error", ({ message }) => { console.error(message); });
                    player.addListener("account_error", ({ message }) => { console.error(message); });
                    player.addListener("playback_error", ({ message }) => { console.error(message); });

                    // Playback state changes
                    player.addListener("player_state_changed", (state) => {
                        if (!state) return;
                        console.log(state);
                    });

                    // Ready to play
                    player.addListener("ready", ({ device_id }) => {
                        console.log("Player is ready with device ID", device_id);
                        spotifyPlayerDiv.style.display = "block";
                    });

                    // Connect to the player
                    player.connect();
                };
            };
        }

        // Event listeners
        searchBtn.addEventListener("click", async () => {
            const query = searchInput.value.trim();
            if (query) {
                const data = await searchSpotify(query);
                if (data) {
                    displayResults(data);
                }
            } else {
                alert("Please enter a search query.");
            }
        });

        loginBtn.addEventListener("click", () => {
            if (!accessToken) {
                loginSpotify(); // Redirect to Spotify login if not logged in
            }
        });

        // Check login status and initialize on page load
        checkLoginStatus();

        // Handle Spotify redirect after authentication
        if (window.location.search.includes("code=")) {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get("code");
            if (code) {
                getAccessTokenFromCode(code);
            }
        }
    </script>
</body>
</html>
